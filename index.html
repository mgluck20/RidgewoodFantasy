<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sleeper Fantasy League Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

<header class="bg-indigo-600 text-white p-6 shadow">
  <h1 class="text-3xl font-bold">Sleeper Fantasy League Dashboard</h1>
  <p class="text-indigo-200 mt-1">Track bonuses, standings, and transactions in real-time</p>
</header>

<main class="p-6 space-y-8">

  <!-- MONEY LEADERBOARD -->
  <section id="money-leaderboard" class="bg-white rounded-xl shadow p-6">
    <h2 class="text-2xl font-semibold mb-4">üí∞ Money Leaderboard</h2>
    <table class="min-w-full border border-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="py-2 px-4 border-b">Rank</th>
          <th class="py-2 px-4 border-b">Team / Owner</th>
          <th class="py-2 px-4 border-b">Total Winnings</th>
          <th class="py-2 px-4 border-b">Weekly Wins</th>
        </tr>
      </thead>
      <tbody id="money-leaderboard-body"></tbody>
    </table>
  </section>

  <!-- LEAGUE STANDINGS -->
  <section id="league-standings" class="bg-white rounded-xl shadow p-6">
    <h2 class="text-2xl font-semibold mb-4">üìä League Standings</h2>
    <table class="min-w-full border border-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="py-2 px-4 border-b">Rank</th>
          <th class="py-2 px-4 border-b">Team / Owner</th>
          <th class="py-2 px-4 border-b">Record</th>
          <th class="py-2 px-4 border-b">Points For</th>
          <th class="py-2 px-4 border-b">Points Against</th>
        </tr>
      </thead>
      <tbody id="league-standings-body"></tbody>
    </table>
  </section>

  <!-- WEEKLY HIGH SCORERS -->
  <section id="weekly-winners" class="bg-white rounded-xl shadow p-6">
    <h2 class="text-2xl font-semibold mb-4">üèÜ Weekly High Scorers</h2>
    <table class="min-w-full border border-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="py-2 px-4 border-b">Week</th>
          <th class="py-2 px-4 border-b">Team / Owner</th>
          <th class="py-2 px-4 border-b">Points</th>
          <th class="py-2 px-4 border-b">Bonus</th>
        </tr>
      </thead>
      <tbody id="weekly-winners-body"></tbody>
    </table>
  </section>

  <!-- RECENT TRANSACTIONS -->
  <section id="recent-transactions" class="bg-white rounded-xl shadow p-6">
    <h2 class="text-2xl font-semibold mb-4">üìù Recent Transactions</h2>
    <table class="min-w-full border border-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="py-2 px-4 border-b">Week</th>
          <th class="py-2 px-4 border-b">Type</th>
          <th class="py-2 px-4 border-b">Status</th>
          <th class="py-2 px-4 border-b">Roster Count</th>
          <th class="py-2 px-4 border-b">Date</th>
        </tr>
      </thead>
      <tbody id="recent-transactions-body"></tbody>
    </table>
  </section>

</main>

<script>
async function fetchCSV(url) {
  const resp = await fetch(url);
  const text = await resp.text();
  const rows = text.split('\n').filter(r => r.trim() !== '');
  return rows.map(r => r.split(','));
}

function moneyLeaderboard(config, owners, bonuses) {
  const ownerMap = {};
  owners.slice(1).forEach(o => ownerMap[o[0]] = {display_name: o[1], team_name: o[2]});
  const totals = {};
  const wins = {};
  bonuses.slice(1).forEach(b => {
    const ownerId = b[1];
    const type = b[3];
    const amount = Number(b[5]);
    totals[ownerId] = (totals[ownerId] || 0) + amount;
    if(type==='HIGH_SCORE') wins[ownerId] = (wins[ownerId]||0)+1;
  });
  const leaderboard = Object.keys(ownerMap).map(id => ({
    rank:0,
    display_name: ownerMap[id].display_name,
    team_name: ownerMap[id].team_name,
    total_bonuses: totals[id]||0,
    wins: wins[id]||0
  })).sort((a,b)=>b.total_bonuses-a.total_bonuses);
  leaderboard.forEach((e,i)=>e.rank=i+1);
  return leaderboard;
}

function leagueStandings(rosters, owners) {
  const ownerMap = {};
  owners.slice(1).forEach(o=>ownerMap[o[0]]={display_name:o[1],team_name:o[2]});
  const standings = rosters.slice(1).map(r=>{
    const owner = ownerMap[r[1]]||{display_name:'Unknown',team_name:''};
    return {
      rank:0,
      display_name: owner.display_name,
      team_name: owner.team_name,
      wins: Number(r[2]),
      losses: Number(r[3]),
      ties: Number(r[4]),
      points_for: Number(r[5]),
      points_against: Number(r[6])
    };
  }).sort((a,b)=>{
    if(b.wins!==a.wins) return b.wins-a.wins;
    return b.points_for-a.points_for;
  });
  standings.forEach((e,i)=>e.rank=i+1);
  return standings;
}

function weeklyWinners(bonuses, owners) {
  const ownerMap = {};
  owners.slice(1).forEach(o=>ownerMap[o[0]]={display_name:o[1],team_name:o[2]});
  const highScores = bonuses.slice(1).filter(b=>b[3]==='HIGH_SCORE')
    .map(b=>{
      const owner = ownerMap[b[1]]||{display_name:'Unknown',team_name:''};
      return {week:b[0],display_name:owner.display_name,team_name:owner.team_name,points:b[4],amount:b[5]};
    }).sort((a,b)=>a.week-b.week);
  return highScores;
}

function recentTransactions(transactions){
  return transactions.slice(1).map(t=>({
    week:t[0],
    type:t[2],
    status:t[3],
    roster_count:t[4]?t[4].split(' ').length:0,
    date:t[5]
  })).sort((a,b)=>new Date(b.date)-new Date(a.date));
}

function renderTable(id, data, cols){
  const tbody = document.getElementById(id);
  tbody.innerHTML = '';
  data.forEach(row=>{
    const tr = document.createElement('tr');
    tr.classList.add('hover:bg-gray-50');
    cols.forEach(c=>{
      const td = document.createElement('td');
      td.className='py-2 px-4 border-b';
      td.textContent=row[c];
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

async function initDashboard(){
  const [config, owners, rosters, weeklyMatchups, weeklyBonuses, transactions] = await Promise.all([
    fetchCSV('https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv'),
    fetchCSV('https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv'),
    fetchCSV('https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv'),
    fetchCSV('https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv'),
    fetchCSV('https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv'),
    fetchCSV('https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv')
  ]);

  renderTable('money-leaderboard-body', moneyLeaderboard(config,owners,weeklyBonuses), ['rank','display_name','total_bonuses','wins']);
  renderTable('league-standings-body', leagueStandings(rosters,owners), ['rank','display_name','wins','wins','points_for','points_against']);
  renderTable('weekly-winners-body', weeklyWinners(weeklyBonuses,owners), ['week','display_name','points','amount']);
  renderTable('recent-transactions-body', recentTransactions(transactions), ['week','type','status','roster_count','date']);
}

initDashboard();
</script>
</body>
</html>
