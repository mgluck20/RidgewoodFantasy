<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ridgewood Fantasy 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Roboto',sans-serif; margin:0; background:#f4f6f8; color:#333; }
header { background:#1e3a8a; color:white; padding:1rem; text-align:center; }
nav { display:flex; justify-content:center; gap:2rem; background:#3b82f6; padding:0.5rem 0; flex-wrap:wrap; }
nav button { background:none; border:none; color:white; font-weight:bold; cursor:pointer; font-size:1rem; transition:0.2s; }
nav button:hover { opacity:0.8; }
nav button.active { border-bottom:2px solid white; }
main { padding:2rem; max-width:1200px; margin:auto; }
table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:0.95rem; }
table th, table td { padding:0.5rem; border-bottom:1px solid #ccc; text-align:left; }
table th { background:#1e40af; color:white; cursor:pointer; user-select:none; }
tr:nth-child(even) { background:#f0f4ff; }
tr:hover { background:#e0e7ff; }
.section-title { font-size:1.5rem; margin-bottom:0.5rem; color:#1e3a8a; }
#winner-box { background:#facc15; padding:1rem; border-radius:8px; margin-bottom:1rem; font-weight:bold; font-size:1.2rem; transition:0.3s; }
#winner-box span { font-weight:normal; font-size:0.9rem; color:#333; }
.filter-container { margin-bottom:1rem; display:flex; gap:1rem; flex-wrap:wrap; }
.filter-container label { font-weight:bold; }
.filter-container select { padding:0.3rem; }
.summary-box { background:#e0f2fe; padding:0.8rem; border-radius:6px; margin:0.5rem 0; font-weight:bold; display:inline-block; }
#debug-info { margin-top:2rem; padding:1rem; background:#fff3cd; border:1px solid #ffc107; border-radius:4px; font-family:monospace; font-size:0.85rem; white-space:pre-wrap; }
</style>
</head>
<body>

<header>
  <h1>Ridgewood Fantasy 2026</h1>
</header>

<nav>
  <button onclick="showPage('home')" class="active">Home</button>
  <button onclick="showPage('standings')">Standings</button>
  <button onclick="showPage('matchups')">Matchups</button>
  <button onclick="showPage('transactions')">Transactions</button>
</nav>

<main>
<div id="home" class="page">
  <div class="section-title">Latest Winner</div>
  <div id="winner-box">Loading...</div>

  <div class="section-title">Money Leaderboard</div>
  <div class="summary-box" id="total-bonuses">Total Bonuses Paid: $0</div>
  <table id="money-leaderboard">
    <thead>
      <tr><th>Rank</th><th>Owner</th><th>Team</th><th>Wins</th><th>Total Bonuses</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="standings" class="page" style="display:none">
  <div class="section-title">Standings</div>
  <table id="standings-table">
    <thead>
      <tr>
        <th onclick="sortTable('standings-table',0)">Rank</th>
        <th onclick="sortTable('standings-table',1)">Owner</th>
        <th onclick="sortTable('standings-table',2)">Team</th>
        <th onclick="sortTable('standings-table',3)">Wins</th>
        <th onclick="sortTable('standings-table',4)">Losses</th>
        <th onclick="sortTable('standings-table',5)">Ties</th>
        <th onclick="sortTable('standings-table',6)">Points For</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="matchups" class="page" style="display:none">
  <div class="section-title">Weekly Matchups</div>
  <div class="filter-container">
    <label for="matchup-week">Week:</label>
    <select id="matchup-week" onchange="filterMatchups()">
      <option value="all">All Weeks</option>
    </select>
  </div>
  <table id="matchups-table">
    <thead>
      <tr><th>Week</th><th>Home Team</th><th>Away Team</th><th>Score</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="transactions" class="page" style="display:none">
  <div class="section-title">Transactions</div>
  <div class="filter-container">
    <label for="trans-week">Week:</label>
    <select id="trans-week" onchange="filterTransactions()">
      <option value="all">All Weeks</option>
    </select>
  </div>
  <table id="transactions-table">
    <thead>
      <tr><th>Week</th><th>Owner</th><th>Transaction</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="last-updated"></div>
<div id="debug-info"></div>
</main>

<script>
const URL_CONFIG = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=0&single=true&output=csv';
const URL_OWNERS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=1393036626&single=true&output=csv';
const URL_ROSTERS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=700134694&single=true&output=csv';
const URL_WEEKLY_MATCHUPS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=425633695&single=true&output=csv';
const URL_WEEKLY_BONUSES = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=1704595399&single=true&output=csv';
const URL_TRANSACTIONS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=1937108615&single=true&output=csv';

let owners={}, rosters={}, bonuses=[], matchups=[], transactions=[], lastWeek=0;
let debugLog = [];

function addDebug(msg) {
  debugLog.push(msg);
  const debugEl = document.getElementById('debug-info');
  if(debugEl) debugEl.textContent = debugLog.join('\n');
  console.log(msg);
}

function csvToArray(csv){
  const lines = csv.trim().split('\n');
  const headers = lines[0].split(',').map(h=>h.trim());
  return lines.slice(1).map(line=>{
    // Handle quoted fields that may contain commas
    const values = [];
    let current = '';
    let inQuotes = false;
    for(let i=0; i<line.length; i++){
      const char = line[i];
      if(char === '"') inQuotes = !inQuotes;
      else if(char === ',' && !inQuotes){
        values.push(current.trim());
        current = '';
      } else current += char;
    }
    values.push(current.trim());
    
    const obj={};
    headers.forEach((h,i)=>obj[h]=(values[i]||'').replace(/^"|"$/g,'').trim());
    return obj;
  });
}

async function loadData(){
  try {
    addDebug('Starting data load...');
    
    const [ownersCsv, rostersCsv, bonusesCsv, matchupsCsv, transactionsCsv, configCsv] = await Promise.all([
      fetch(URL_OWNERS).then(r=>r.text()),
      fetch(URL_ROSTERS).then(r=>r.text()),
      fetch(URL_WEEKLY_BONUSES).then(r=>r.text()),
      fetch(URL_WEEKLY_MATCHUPS).then(r=>r.text()),
      fetch(URL_TRANSACTIONS).then(r=>r.text()),
      fetch(URL_CONFIG).then(r=>r.text())
    ]);
    
    addDebug('All CSVs fetched successfully');

    // Parse owners and log for debugging
    const ownersArray = csvToArray(ownersCsv);
    addDebug(`Owners loaded: ${ownersArray.length} entries`);
    addDebug(`Owner columns: ${Object.keys(ownersArray[0] || {}).join(', ')}`);
    addDebug(`First owner sample: ${JSON.stringify(ownersArray[0])}`);
    
    ownersArray.forEach(o=>owners[o.owner_id]={ display_name:o.display_name||'Unknown', team_name:o.team_name||'Unknown' });
    addDebug(`Owner IDs in map: ${Object.keys(owners).join(', ')}`);
    
    csvToArray(rostersCsv).forEach(r=>rosters[r.owner_id]={ ...r, wins:Number(r.wins||0), losses:Number(r.losses||0), ties:Number(r.ties||0), points_for:Number(r.points_for||0) });
    
    bonuses = csvToArray(bonusesCsv).map(b=>({...b, week:Number(b.week||0), amount:Number(b.amount||0)}));
    
    // Parse matchups and log for debugging
    const matchupsArray = csvToArray(matchupsCsv);
    addDebug(`Matchups loaded: ${matchupsArray.length} entries`);
    addDebug(`Matchup columns: ${Object.keys(matchupsArray[0] || {}).join(', ')}`);
    addDebug(`First matchup sample: ${JSON.stringify(matchupsArray[0])}`);
    matchups = matchupsArray.map(m=>({...m, week:Number(m.week||0), score:m.score||0}));
    
    // Parse transactions and log for debugging
    const transactionsArray = csvToArray(transactionsCsv);
    addDebug(`Transactions loaded: ${transactionsArray.length} entries`);
    addDebug(`Transaction columns: ${Object.keys(transactionsArray[0] || {}).join(', ')}`);
    addDebug(`First transaction sample: ${JSON.stringify(transactionsArray[0])}`);
    transactions = transactionsArray;

    const configRows = csvToArray(configCsv);
    const weekRow = configRows.find(r=>r.Key==='LastProcessedWeek');
    lastWeek = weekRow ? Number(weekRow.Value||0) : 0;
    document.getElementById('last-updated').textContent = lastWeek>0?`Week ${lastWeek} processed`:'No weeks processed yet';

    populateWeekFilters();
    loadHome(); loadStandings(); loadMatchups(); loadTransactions();
    
    addDebug('âœ“ Data load complete!');
  } catch(error) {
    addDebug(`ERROR: ${error.message}`);
    console.error('Load error:', error);
  }
}

function populateWeekFilters(){
  const weeks = Array.from(new Set([...matchups.map(m=>m.week), ...transactions.map(t=>Number(t.week))])).sort((a,b)=>a-b);
  const matchupSelect = document.getElementById('matchup-week');
  const transSelect = document.getElementById('trans-week');
  weeks.forEach(w=>{
    const opt1=document.createElement('option'); opt1.value=w; opt1.text=`Week ${w}`; matchupSelect.appendChild(opt1);
    const opt2=document.createElement('option'); opt2.value=w; opt2.text=`Week ${w}`; transSelect.appendChild(opt2);
  });
}

function loadHome(){
  const latest = bonuses.sort((a,b)=>b.week-a.week)[0];
  const winnerBox = document.getElementById('winner-box');
  if(latest){
    const owner = owners[latest.owner_id]||{ display_name:'Unknown', team_name:'Unknown' };
    winnerBox.innerHTML = `${owner.display_name} (${owner.team_name}) won <strong>$${latest.amount}</strong> in Week ${latest.week}`;
  } else winnerBox.textContent='No winners yet';

  const moneyMap={};
  bonuses.forEach(b=>{
    if(!moneyMap[b.owner_id]) moneyMap[b.owner_id]={ total:0, wins:0, owner: owners[b.owner_id]||{ display_name:'Unknown', team_name:'Unknown' } };
    moneyMap[b.owner_id].total+=b.amount;
    if(b.bonus_type==='HIGH_SCORE') moneyMap[b.owner_id].wins+=1;
  });
  const leaderboard=Object.values(moneyMap).sort((a,b)=>b.total-a.total);
  const tbody=document.querySelector('#money-leaderboard tbody'); tbody.innerHTML='';
  let totalPaid=0;
  leaderboard.forEach((l,i)=>{
    totalPaid+=l.total;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${l.owner.display_name}</td><td>${l.owner.team_name}</td><td>${l.wins}</td><td>$${l.total}</td>`;
    if(i<3) tr.style.background='#fde68a';
    tbody.appendChild(tr);
  });
  document.getElementById('total-bonuses').textContent=`Total Bonuses Paid: $${totalPaid}`;
}

function loadStandings(){
  const data=Object.values(rosters).sort((a,b)=>b.wins-a.wins || b.points_for-a.points_for);
  const tbody=document.querySelector('#standings-table tbody'); tbody.innerHTML='';
  data.forEach((r,i)=>{
    const o=owners[r.owner_id]||{ display_name:'Unknown', team_name:'Unknown' };
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${o.display_name}</td><td>${o.team_name}</td><td>${r.wins}</td><td>${r.losses}</td><td>${r.ties}</td><td>${r.points_for}</td>`;
    tbody.appendChild(tr);
  });
}

function loadMatchups(filterWeek='all'){
  const tbody=document.querySelector('#matchups-table tbody'); tbody.innerHTML='';
  matchups.filter(m=>filterWeek==='all'||m.week==filterWeek).forEach(m=>{
    const home=owners[m.home_owner_id]||{ team_name:'Unknown' };
    const away=owners[m.away_owner_id]||{ team_name:'Unknown' };
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m.week}</td><td>${home.team_name}</td><td>${away.team_name}</td><td>${m.score}</td>`;
    tbody.appendChild(tr);
  });
}

function loadTransactions(filterWeek='all'){
  const tbody=document.querySelector('#transactions-table tbody'); tbody.innerHTML='';
  transactions.filter(t=>filterWeek==='all'||Number(t.week)==filterWeek).forEach(t=>{
    const owner=owners[t.owner_id]||{ team_name:'Unknown' };
    const tr=document.createElement('tr');
    const text=t.transaction||t.Action||'N/A';
    const week=Number(t.week)||0;
    tr.innerHTML=`<td>${week}</td><td>${owner.team_name}</td><td>${text}</td>`;
    tbody.appendChild(tr);
  });
}

function filterMatchups(){ loadMatchups(document.getElementById('matchup-week').value); }
function filterTransactions(){ loadTransactions(document.getElementById('trans-week').value); }

function showPage(page){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.getElementById(page).style.display='block';
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.querySelector(`nav button[onclick="showPage('${page}')"]`).classList.add('active');
}

function sortTable(tableId, col){
  const table=document.getElementById(tableId); let switching=true, dir='asc';
  while(switching){
    switching=false; const rows=table.rows; for(let i=1;i<rows.length-1;i++){
      let shouldSwitch=false, x=rows[i].getElementsByTagName('TD')[col], y=rows[i+1].getElementsByTagName('TD')[col];
      let xContent=x.textContent||x.innerText, yContent=y.textContent||y.innerText;
      if(!isNaN(xContent) && !isNaN(yContent)){ xContent=Number(xContent); yContent=Number(yContent); }
      if((dir=='asc' && xContent>yContent) || (dir=='desc' && xContent<yContent)){ shouldSwitch=true; break; }
    }
    if(shouldSwitch){ rows[i].parentNode.insertBefore(rows[i+1],rows[i]); switching=true; }
    else if(dir=='asc'){ dir='desc'; switching=true; }
  }
}

window.onload = loadData;
</script>

</body>
</html>
