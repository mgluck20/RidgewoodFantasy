<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ridgewood Fantasy 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family:'Inter',sans-serif;
  background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
  color:#fff;
  min-height:100vh;
}
header {
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(10px);
  padding:2rem 1rem;
  text-align:center;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  position:relative;
}
header h1 {
  font-size:2.5rem;
  font-weight:800;
  letter-spacing:-1px;
  background: linear-gradient(to right, #00d4ff, #00ffbb);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.sleeper-link {
  position:absolute;
  right:2rem;
  top:50%;
  transform:translateY(-50%);
  background: linear-gradient(135deg, #00d4ff 0%, #00ffbb 100%);
  color:#0f2027;
  padding:0.75rem 1.5rem;
  border-radius:12px;
  text-decoration:none;
  font-weight:700;
  font-size:0.9rem;
  transition: all 0.3s ease;
}
.sleeper-link:hover {
  transform:translateY(-50%) scale(1.05);
  box-shadow: 0 8px 20px rgba(0,212,255,0.4);
}
nav {
  display:flex;
  justify-content:center;
  gap:0.5rem;
  background: rgba(0,0,0,0.3);
  backdrop-filter: blur(10px);
  padding:1rem;
  flex-wrap:wrap;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
nav button {
  background: rgba(255,255,255,0.1);
  border:none;
  color:white;
  font-weight:600;
  cursor:pointer;
  font-size:0.9rem;
  padding:0.75rem 1.25rem;
  border-radius:12px;
  transition: all 0.3s ease;
  position:relative;
  overflow:hidden;
}
nav button::before {
  content:'';
  position:absolute;
  top:0; left:0; right:0; bottom:0;
  background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(0,255,187,0));
  opacity:0;
  transition: opacity 0.3s ease;
}
nav button:hover::before { opacity:1; }
nav button:hover {
  background: rgba(255,255,255,0.2);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
nav button.active {
  background: linear-gradient(135deg, #00d4ff 0%, #00ffbb 100%);
  color:#0f2027;
  box-shadow: 0 4px 15px rgba(0,212,255,0.4);
}
main {
  padding:2rem;
  max-width:1400px;
  margin:auto;
}
.section-title {
  font-size:1.8rem;
  margin-bottom:1.5rem;
  font-weight:700;
  display:flex;
  align-items:center;
  gap:0.5rem;
}
.section-title::before {
  content:'';
  width:4px;
  height:30px;
  background: linear-gradient(to bottom, #00d4ff, #00ffbb);
  border-radius:2px;
}
.card {
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(20px);
  border-radius:20px;
  padding:2rem;
  margin-bottom:2rem;
  border: 1px solid rgba(255,255,255,0.15);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}
#winner-box {
  background: linear-gradient(135deg, #00d4ff 0%, #00ffbb 100%);
  color:#0f2027;
  padding:2rem;
  border-radius:20px;
  margin-bottom:2rem;
  font-weight:600;
  font-size:1.3rem;
  box-shadow: 0 8px 32px rgba(0,212,255,0.3);
  position:relative;
  overflow:hidden;
}
#winner-box::before {
  content:'üèÜ';
  position:absolute;
  right:20px;
  top:50%;
  transform:translateY(-50%);
  font-size:4rem;
  opacity:0.5;
}
.stats-grid {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap:1.5rem;
  margin-bottom:2rem;
}
.stat-card {
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(20px);
  border-radius:16px;
  padding:1.5rem;
  border: 1px solid rgba(255,255,255,0.15);
  text-align:center;
}
.stat-value {
  font-size:2.5rem;
  font-weight:800;
  background: linear-gradient(135deg, #00d4ff 0%, #00ffbb 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.stat-label {
  font-size:0.9rem;
  opacity:0.8;
  margin-top:0.5rem;
  font-weight:500;
}
table {
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  font-size:0.95rem;
}
table th, table td {
  padding:1rem;
  text-align:left;
}
table th {
  background: rgba(255,255,255,0.12);
  color:white;
  cursor:pointer;
  user-select:none;
  font-weight:600;
  text-transform:uppercase;
  font-size:0.85rem;
  letter-spacing:0.5px;
  border-bottom: 2px solid rgba(0,212,255,0.5);
  position:sticky;
  top:0;
  z-index:10;
}
table th:hover {
  background: rgba(255,255,255,0.18);
}
table tbody tr {
  background: rgba(255,255,255,0.04);
  transition: all 0.2s ease;
}
table tbody tr:hover {
  background: rgba(255,255,255,0.12);
  transform: scale(1.01);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
table tbody tr td {
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.rank-badge {
  display:inline-block;
  width:32px;
  height:32px;
  border-radius:50%;
  background: linear-gradient(135deg, #00d4ff 0%, #00ffbb 100%);
  text-align:center;
  line-height:32px;
  font-weight:700;
  font-size:0.9rem;
  color:#0f2027;
}
.rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color:#000; }
.rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%); color:#000; }
.rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); }
.team-logo {
  width:40px;
  height:40px;
  border-radius:50%;
  background: linear-gradient(135deg, #00d4ff 0%, #00ffbb 100%);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:1.2rem;
  margin-right:0.75rem;
  vertical-align:middle;
  border: 2px solid rgba(255,255,255,0.3);
  color:#0f2027;
}
.team-cell {
  display:flex;
  align-items:center;
  gap:0.75rem;
}
.team-info {
  display:flex;
  flex-direction:column;
}
.team-name {
  font-weight:600;
  font-size:1rem;
}
.owner-name {
  font-size:0.85rem;
  opacity:0.7;
}
.filter-container {
  margin-bottom:1.5rem;
  display:flex;
  gap:1rem;
  align-items:center;
  flex-wrap:wrap;
}
.filter-container label {
  font-weight:600;
  font-size:0.95rem;
}
.filter-container select {
  padding:0.75rem 1rem;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius:10px;
  color:white;
  font-weight:500;
  cursor:pointer;
  transition: all 0.3s ease;
  font-size:0.95rem;
}
.filter-container select:hover {
  background: rgba(255,255,255,0.15);
}
.filter-container select option {
  background:#203a43;
  color:white;
}
.score-display {
  font-weight:700;
  font-size:1.1rem;
  padding:0.5rem 1rem;
  background: rgba(255,255,255,0.1);
  border-radius:8px;
  display:inline-block;
}
.transaction-badge {
  display:inline-block;
  padding:0.6rem 1rem;
  border-radius:8px;
  font-size:1rem;
  font-weight:600;
  text-transform:uppercase;
}
.transaction-trade { background: rgba(255, 165, 0, 0.3); color:#ffa500; }
.transaction-free_agent, .transaction-waiver { background: rgba(0, 255, 187, 0.3); color:#00ffbb; }
.playoff-bracket {
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(20px);
  border-radius:20px;
  padding:3rem;
  text-align:center;
  min-height:400px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
.playoff-placeholder {
  font-size:4rem;
  margin-bottom:1rem;
  opacity:0.3;
}
.playoff-text {
  font-size:1.5rem;
  font-weight:600;
  opacity:0.7;
}
.playoff-note {
  margin-top:1rem;
  opacity:0.5;
  font-size:1rem;
  max-width:600px;
}
#last-updated {
  text-align:center;
  padding:1rem;
  opacity:0.6;
  font-size:0.9rem;
  margin-top:2rem;
}
#debug-info {
  margin-top:2rem;
  padding:1rem;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(10px);
  border:1px solid rgba(255,255,255,0.2);
  border-radius:12px;
  font-family:monospace;
  font-size:0.8rem;
  white-space:pre-wrap;
  max-height:400px;
  overflow-y:auto;
}
.page { animation: fadeIn 0.3s ease; }
@keyframes fadeIn {
  from { opacity:0; transform:translateY(10px); }
  to { opacity:1; transform:translateY(0); }
}
::-webkit-scrollbar { width:10px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius:10px; }
::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #00d4ff 0%, #00ffbb 100%);
  border-radius:10px;
}
::-webkit-scrollbar-thumb:hover { background: #00d4ff; }
@media (max-width: 768px) {
  header h1 { font-size:1.8rem; }
  .sleeper-link { position:static; transform:none; margin-top:1rem; display:inline-block; }
  .section-title { font-size:1.4rem; }
  table { font-size:0.85rem; }
  table th, table td { padding:0.75rem 0.5rem; }
  .team-logo { width:32px; height:32px; font-size:1rem; }
}
</style>
</head>
<body>
<header>
  <h1>‚ö° Ridgewood Fantasy 2026 ‚ö°</h1>
  <a href="https://sleeper.com/leagues/1127785690072428544" target="_blank" class="sleeper-link">Open in Sleeper</a>
</header>
<nav>
  <button onclick="showPage('home')" class="active">Home</button>
  <button onclick="showPage('standings')">Standings</button>
  <button onclick="showPage('matchups')">Matchups</button>
  <button onclick="showPage('transactions')">Transactions</button>
  <button onclick="showPage('playoffs')">Playoffs</button>
  <button onclick="showPage('trending')">Trending</button>
</nav>
<main>
<div id="home" class="page">
  <div class="section-title">Latest Winner</div>
  <div id="winner-box">Loading...</div>
  <div class="stats-grid" id="stats-grid"></div>
  <div class="section-title">Money Leaderboard</div>
  <div class="card">
    <table id="money-leaderboard">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Team</th>
          <th>Weekly Wins</th>
          <th>Total Earnings</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<div id="standings" class="page" style="display:none">
  <div class="section-title">League Standings</div>
  <div class="card">
    <table id="standings-table">
      <thead>
        <tr>
          <th onclick="sortTable('standings-table',0)">Rank</th>
          <th onclick="sortTable('standings-table',1)">Team</th>
          <th onclick="sortTable('standings-table',2)">Record</th>
          <th onclick="sortTable('standings-table',3)">Points For</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<div id="matchups" class="page" style="display:none">
  <div class="section-title">Weekly Matchups</div>
  <div class="filter-container">
    <label for="matchup-week">Week:</label>
    <select id="matchup-week" onchange="filterMatchups()">
      <option value="all">All Weeks</option>
    </select>
    <label for="matchup-team">Team:</label>
    <select id="matchup-team" onchange="filterMatchups()">
      <option value="all">All Teams</option>
    </select>
  </div>
  <div class="card">
    <table id="matchups-table">
      <thead>
        <tr>
          <th>Week</th>
          <th>Team 1</th>
          <th>Team 2</th>
          <th>Score</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<div id="transactions" class="page" style="display:none">
  <div class="section-title">Recent Transactions</div>
  <div class="filter-container">
    <label for="trans-week">Week:</label>
    <select id="trans-week" onchange="filterTransactions()">
      <option value="all">All Weeks</option>
    </select>
  </div>
  <div class="card">
    <div id="transactions-list">
      Loading transactions...
    </div>
  </div>
</div>
<div id="playoffs" class="page" style="display:none">
  <div class="section-title">Playoff Bracket</div>
  <div class="card">
    <div class="playoff-bracket">
      <div class="playoff-placeholder">üèÜ</div>
      <div class="playoff-text">2025 Season Complete!</div>
      <div class="playoff-note">
        The 2025 fantasy season has concluded. Full playoff bracket and results are available in the Sleeper app.
      </div>
    </div>
  </div>
</div>
<div id="trending" class="page" style="display:none">
  <div class="section-title">Trending Players</div>
  <div class="card">
    <div id="trending-players">Loading trending players...</div>
  </div>
</div>
<div id="last-updated"></div>
<div id="debug-info"></div>
</main>
<script>
const URL_CONFIG = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=0&single=true&output=csv';
const URL_OWNERS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=1393036626&single=true&output=csv';
const URL_ROSTERS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=700134694&single=true&output=csv';
const URL_WEEKLY_MATCHUPS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=425633695&single=true&output=csv';
const URL_WEEKLY_BONUSES = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=1704595399&single=true&output=csv';
const URL_TRANSACTIONS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?gid=1937108615&single=true&output=csv';
const SLEEPER_PLAYERS_URL = 'https://api.sleeper.app/v1/players/nfl';
const SLEEPER_TRENDING_URL = 'https://api.sleeper.app/v1/players/nfl/trending/add?lookback_hours=24&limit=25';

let owners = {}, rosters = {}, bonuses = [], matchups = [], transactions = [], lastWeek = 17;
let rosterToOwner = {};
let sleeperPlayers = {};

function addDebug(msg) {
  console.log(msg);
  const debugEl = document.getElementById('debug-info');
  if (debugEl) {
    debugEl.textContent += msg + '\n';
    debugEl.scrollTop = debugEl.scrollHeight;
  }
}

function getPlayerName(playerId) {
  const p = sleeperPlayers[playerId];
  if (!p) return `Player ${playerId}`;
  return `${p.first_name || ''} ${p.last_name || ''}`.trim() || `Player ${playerId}`;
}

function getTeamName(owner) {
  if (!owner) return 'Unknown';
  if (owner.team_name && owner.team_name !== 'Unknown' && owner.team_name.trim() !== '') return owner.team_name.trim();
  return `Team ${owner.display_name}`;
}

function getTeamInitials(teamName) {
  return teamName.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
}

function getTeamColor(teamName) {
  const colors = [
    ['#00d4ff', '#00ffbb'], ['#ff6b6b', '#ff8787'], ['#4facfe', '#00f2fe'],
    ['#43e97b', '#38f9d7'], ['#fa709a', '#fee140'], ['#30cfd0', '#330867'],
    ['#a8edea', '#fed6e3'], ['#ff9a9e', '#fecfef']
  ];
  const hash = teamName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
  return colors[hash % colors.length];
}

function createTeamLogo(teamName) {
  const initials = getTeamInitials(teamName);
  const [color1, color2] = getTeamColor(teamName);
  return `<div class="team-logo" style="background: linear-gradient(135deg, ${color1} 0%, ${color2} 100%);">${initials}</div>`;
}

function csvToArray(csv) {
  const lines = csv.trim().split('\n');
  if (lines.length < 1) return [];
  const headers = lines[0].split(',').map(h => h.trim());
  return lines.slice(1).map(line => {
    const values = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') inQuotes = !inQuotes;
      else if (char === ',' && !inQuotes) {
        values.push(current.trim());
        current = '';
      } else current += char;
    }
    values.push(current.trim());
    const obj = {};
    headers.forEach((h, i) => obj[h] = (values[i] || '').replace(/^"|"$/g, '').trim());
    return obj;
  });
}

async function loadSleeperPlayers() {
  try {
    const response = await fetch(SLEEPER_PLAYERS_URL);
    if (response.ok) {
      sleeperPlayers = await response.json();
      addDebug(`Loaded ${Object.keys(sleeperPlayers).length} Sleeper players`);
    }
  } catch (error) {
    addDebug(`Error loading Sleeper players: ${error.message}`);
  }
}

async function loadTrendingPlayers() {
  try {
    const response = await fetch(SLEEPER_TRENDING_URL);
    if (!response.ok) throw new Error('Trending API error');
    const trending = await response.json();
    const container = document.getElementById('trending-players');
    if (!trending || trending.length === 0) {
      container.innerHTML = '<p style="text-align:center; opacity:0.7;">No trending players available</p>';
      return;
    }
    let html = '<table style="width:100%;"><thead><tr><th>Rank</th><th>Player</th><th>Position</th><th>Team</th><th>Adds</th></tr></thead><tbody>';
    trending.forEach((item, i) => {
      const player = sleeperPlayers[item.player_id] || {};
      const fullName = `${player.first_name || ''} ${player.last_name || ''}`.trim() || 'Unknown';
      html += `<tr>
        <td><span class="rank-badge">${i+1}</span></td>
        <td style="font-weight:600;">${fullName}</td>
        <td>${player.position || 'N/A'}</td>
        <td>${player.team || 'N/A'}</td>
        <td style="color:#00ffbb; font-weight:700;">+${item.count || 0}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    document.getElementById('trending-players').innerHTML = `<p style="text-align:center; opacity:0.7;">Error loading trending players</p>`;
    addDebug(`Error loading trending: ${error.message}`);
  }
}

async function loadData() {
  document.getElementById('transactions-list').innerHTML = 'Loading data...';
  try {
    addDebug('Starting data load...');
    await loadSleeperPlayers();

    const [ownersCsv, rostersCsv, bonusesCsv, matchupsCsv, transactionsCsv, configCsv] = await Promise.all([
      fetch(URL_OWNERS).then(r => r.text()),
      fetch(URL_ROSTERS).then(r => r.text()),
      fetch(URL_WEEKLY_BONUSES).then(r => r.text()),
      fetch(URL_WEEKLY_MATCHUPS).then(r => r.text()),
      fetch(URL_TRANSACTIONS).then(r => r.text()),
      fetch(URL_CONFIG).then(r => r.text())
    ]);

    addDebug('All CSVs fetched successfully');

    // Parse owners and rosters
    const ownersArray = csvToArray(ownersCsv);
    ownersArray.forEach(o => owners[o.owner_id] = { display_name: o.display_name || 'Unknown', team_name: o.team_name || '' });

    const rostersArray = csvToArray(rostersCsv);
    rostersArray.forEach(r => {
      rosters[r.owner_id] = { ...r, wins: Number(r.wins || 0), losses: Number(r.losses || 0), ties: Number(r.ties || 0), points_for: Number(r.points_for || 0) };
      if (r.roster_id && r.owner_id) rosterToOwner[r.roster_id] = r.owner_id;
    });

    bonuses = csvToArray(bonusesCsv).map(b => ({ ...b, week: Number(b.week || 0), amount: Number(b.amount || 0), bonus_type: b.bonus_type || 'HIGH_SCORE' }));
    matchups = csvToArray(matchupsCsv).map(m => ({ ...m, week: Number(m.week || 0), points: Number(m.points || 0) }));

    // Transactions parsing with robust handling
    transactions = csvToArray(transactionsCsv).map(t => {
      const parsed = {
        week: Number(t.leg || t.week || 0),
        roster_ids: t.roster_ids ? t.roster_ids.split(',').map(id => id.trim()) : [],
        type: t.type || 'unknown',
        created: Number(t.created || t.status_updated || 0) || 0,
        adds: {},
        drops: {},
        draft_picks: [],
        waiver_budget: []
      };

      // Robust parse for JSON fields (handle empty, null, single quotes)
      const robustParse = (field) => {
        let str = t[field] || '';
        if (!str || str.trim() === '' || str === 'null' || str === '{}') return field === 'draft_picks' || field === 'waiver_budget' ? [] : {};
        str = str.replace(/'/g, '"').trim();
        try {
          return JSON.parse(str);
        } catch (e) {
          addDebug(`Parse error in ${field}: ${str}`);
          return field === 'draft_picks' || field === 'waiver_budget' ? [] : {};
        }
      };

      parsed.adds = robustParse('adds');
      parsed.drops = robustParse('drops');
      parsed.draft_picks = robustParse('draft_picks');
      parsed.waiver_budget = robustParse('waiver_budget');

      return parsed;
    }).filter(t => t.week > 0); // Filter out invalid weeks

    addDebug(`Parsed ${transactions.length} transactions`);

    const configRows = csvToArray(configCsv);
    const weekRow = configRows.find(r => r.Key === 'LastProcessedWeek');
    lastWeek = weekRow ? Math.min(Number(weekRow.Value || 17), 17) : 17;

    document.getElementById('last-updated').textContent = `Season Complete ‚Äì Regular season: ${lastWeek} weeks`;

    populateWeekFilters();
    populateTeamFilter();
    loadHome();
    loadStandings();
    loadMatchups();
    loadTransactions();
    loadTrendingPlayers();

    addDebug('Data load complete!');
  } catch (error) {
    addDebug(`ERROR: ${error.message}`);
    document.getElementById('transactions-list').innerHTML = '<p style="text-align:center; opacity:0.7;">Error loading data. Check console/debug.</p>';
  }
}

function populateWeekFilters() {
  const weeks = Array.from(new Set([...matchups.map(m => m.week), ...transactions.map(t => t.week)])).filter(w => w > 0).sort((a, b) => a - b);
  const matchupSelect = document.getElementById('matchup-week');
  const transSelect = document.getElementById('trans-week');
  weeks.forEach(w => {
    const opt1 = document.createElement('option'); opt1.value = w; opt1.text = `Week ${w}`; matchupSelect.appendChild(opt1);
    const opt2 = document.createElement('option'); opt2.value = w; opt2.text = `Week ${w}`; transSelect.appendChild(opt2);
  });
}

function populateTeamFilter() {
  const teamSelect = document.getElementById('matchup-team');
  Object.values(owners).sort((a, b) => getTeamName(a).localeCompare(getTeamName(b))).forEach(o => {
    const teamName = getTeamName(o);
    const opt = document.createElement('option');
    opt.value = teamName;
    opt.text = teamName;
    teamSelect.appendChild(opt);
  });
}

function loadHome() {
  const latest = bonuses.sort((a, b) => b.week - a.week)[0];
  const winnerBox = document.getElementById('winner-box');
  if (latest && latest.owner_id && owners[latest.owner_id]) {
    const owner = owners[latest.owner_id];
    const teamName = getTeamName(owner);
    winnerBox.innerHTML = `${createTeamLogo(teamName)} <span style="vertical-align:middle;">${owner.display_name} (${teamName}) won <strong>$${latest.amount}</strong> in Week ${latest.week}!</span>`;
  } else {
    winnerBox.textContent = 'No weekly winners recorded';
  }

  const totalPaid = bonuses.reduce((sum, b) => sum + b.amount, 0);
  const totalTeams = Object.keys(owners).length;
  const statsGrid = document.getElementById('stats-grid');
  statsGrid.innerHTML = `
    <div class="stat-card">
      <div class="stat-value">$${totalPaid}</div>
      <div class="stat-label">Total Paid Out</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${totalTeams}</div>
      <div class="stat-label">Teams</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${lastWeek}</div>
      <div class="stat-label">Weeks Played</div>
    </div>
  `;

  // Money leaderboard (unchanged)
  const moneyMap = {};
  Object.keys(owners).forEach(ownerId => moneyMap[ownerId] = { total: 0, wins: 0, owner: owners[ownerId] });
  bonuses.forEach(b => {
    if (moneyMap[b.owner_id]) {
      moneyMap[b.owner_id].total += b.amount;
      if (b.bonus_type.includes('HIGH')) moneyMap[b.owner_id].wins += 1;
    }
  });
  const leaderboard = Object.values(moneyMap).sort((a, b) => b.wins - a.wins || b.total - a.total);
  const tbody = document.querySelector('#money-leaderboard tbody');
  tbody.innerHTML = '';
  leaderboard.forEach((l, i) => {
    const teamName = getTeamName(l.owner);
    const tr = document.createElement('tr');
    const rankClass = i < 3 ? `rank-${i + 1}` : '';
    tr.innerHTML = `
      <td><span class="rank-badge ${rankClass}">${i + 1}</span></td>
      <td><div class="team-cell">${createTeamLogo(teamName)}<div class="team-info"><span class="team-name">${teamName}</span><span class="owner-name">${l.owner.display_name}</span></div></div></td>
      <td>${l.wins}</td>
      <td style="font-weight:700; font-size:1.1rem;">$${l.total}</td>
    `;
    tbody.appendChild(tr);
  });
}

function loadStandings() {
  const data = Object.values(rosters).sort((a, b) => (b.wins - a.wins) || (b.points_for - a.points_for));
  const tbody = document.querySelector('#standings-table tbody');
  tbody.innerHTML = '';
  data.forEach((r, i) => {
    const o = owners[r.owner_id] || { display_name: 'Unknown', team_name: '' };
    const teamName = getTeamName(o);
    const tr = document.createElement('tr');
    const rankClass = i < 3 ? `rank-${i + 1}` : '';
    tr.innerHTML = `
      <td><span class="rank-badge ${rankClass}">${i + 1}</span></td>
      <td><div class="team-cell">${createTeamLogo(teamName)}<div class="team-info"><span class="team-name">${teamName}</span><span class="owner-name">${o.display_name}</span></div></div></td>
      <td style="font-weight:600;">${r.wins}-${r.losses}${r.ties > 0 ? '-' + r.ties : ''}</td>
      <td style="font-weight:700;">${r.points_for.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function loadMatchups(selectedWeek = 'all', selectedTeam = 'all') {
  const tbody = document.querySelector('#matchups-table tbody');
  tbody.innerHTML = '';
  const matchupPairs = {};
  matchups.forEach(m => {
    const key = `${m.week}-${m.matchup_id}`;
    if (!matchupPairs[key]) matchupPairs[key] = [];
    matchupPairs[key].push(m);
  });
  Object.values(matchupPairs).forEach(pair => {
    if (pair.length !== 2) return;
    const week = pair[0].week;
    if (selectedWeek !== 'all' && week != Number(selectedWeek)) return;
    const team1_owner_id = rosterToOwner[pair[0].roster_id];
    const team2_owner_id = rosterToOwner[pair[1].roster_id];
    const team1 = owners[team1_owner_id] || { display_name: 'Unknown', team_name: '' };
    const team2 = owners[team2_owner_id] || { display_name: 'Unknown', team_name: '' };
    const team1Name = getTeamName(team1);
    const team2Name = getTeamName(team2);
    if (selectedTeam !== 'all' && team1Name !== selectedTeam && team2Name !== selectedTeam) return;
    const score1 = pair[0].points;
    const score2 = pair[1].points;
    const winner = score1 > score2 ? 0 : (score2 > score1 ? 1 : -1);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:700;">Week ${week}</td>
      <td><div class="team-cell">${createTeamLogo(team1Name)}<span class="team-name" style="opacity:${winner === 0 ? 1 : 0.6};">${team1Name}</span></div></td>
      <td><div class="team-cell">${createTeamLogo(team2Name)}<span class="team-name" style="opacity:${winner === 1 ? 1 : 0.6};">${team2Name}</span></div></td>
      <td>
        <span class="score-display" style="color:${winner === 0 ? '#00ffbb' : 'rgba(255,255,255,0.6)'};">${score1.toFixed(2)}</span>
        <span style="margin:0 0.5rem;">-</span>
        <span class="score-display" style="color:${winner === 1 ? '#00ffbb' : 'rgba(255,255,255,0.6)'};">${score2.toFixed(2)}</span>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function loadTransactions(filterWeek = 'all') {
  const container = document.getElementById('transactions-list');
  container.innerHTML = '<p style="text-align:center; opacity:0.7;">Loading transactions...</p>';

  const filtered = transactions
    .filter(t => filterWeek === 'all' || t.week == Number(filterWeek))
    .sort((a, b) => b.created - a.created || b.week - a.week);

  if (filtered.length === 0) {
    container.innerHTML = '<p style="text-align:center; opacity:0.7; padding:2rem;">No transactions found for the selected week.</p>';
    return;
  }

  container.innerHTML = ''; // Clear loading

  let currentWeek = null;
  let weekContainer = null;

  filtered.forEach(t => {
    const type = t.type.toLowerCase();
    let typeDisplay = type === 'free_agent' ? 'FREE AGENT' : type === 'waiver' ? 'WAIVER' : type.toUpperCase();
    let badgeClass = type === 'trade' ? 'transaction-trade' : 'transaction-free_agent';

    let dateStr = '';
    if (t.created > 0) {
      const date = new Date(t.created * 1000);
      dateStr = `<div style="font-size:0.85rem; opacity:0.7; margin-top:0.5rem;">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>`;
    }

    // Teams
    let teamsHtml = t.roster_ids.map(rid => {
      const ownerId = rosterToOwner[rid] || '';
      const owner = owners[ownerId] || { display_name: 'Unknown' };
      const teamName = getTeamName(owner);
      return `<div class="team-cell" style="display:inline-flex; align-items:center; gap:0.75rem;">${createTeamLogo(teamName)}<span class="team-name">${teamName}</span></div>`;
    }).join(type === 'trade' ? '<span style="font-size:1.8rem; opacity:0.6; margin:0 1rem;">‚Üî</span>' : '<span style="margin:0 0.5rem;">‚Ä¢</span>');

    if (teamsHtml === '') teamsHtml = 'Unknown Team';

    // Details
    let details = [];

    if (Object.keys(t.adds).length > 0) {
      Object.keys(t.adds).forEach(pid => details.push(`<span style="color:#00ffbb; font-weight:700;">+ ${getPlayerName(pid)}</span>`));
    }
    if (Object.keys(t.drops).length > 0) {
      Object.keys(t.drops).forEach(pid => details.push(`<span style="color:#ff6b6b; font-weight:700;">‚Äì ${getPlayerName(pid)}</span>`));
    }
    if (t.draft_picks.length > 0) {
      t.draft_picks.forEach(pick => {
        const from = getTeamName(owners[rosterToOwner[pick.previous_owner_id || pick.roster_id] || {}]);
        const to = getTeamName(owners[rosterToOwner[pick.owner_id] || {}]);
        details.push(`<strong>${from} ‚Üí ${to}</strong>: ${pick.season} Round ${pick.round}`);
      });
    }
    if (t.waiver_budget.length > 0) {
      t.waiver_budget.forEach(b => {
        const sender = getTeamName(owners[rosterToOwner[b.sender] || {}]);
        const receiver = getTeamName(owners[rosterToOwner[b.receiver] || {}]);
        details.push(`<strong>${sender}</strong> sends $${b.amount} FAAB ‚Üí <strong>${receiver}</strong>`);
      });
    }

    if (details.length === 0) details = ['<span style="opacity:0.6;">No movement recorded</span>'];

    // Week header
    if (t.week !== currentWeek) {
      currentWeek = t.week;
      weekContainer = document.createElement('div');
      weekContainer.innerHTML = `<h3 style="font-size:1.5rem; margin:2rem 0 1rem; color:#00d4ff; border-bottom:2px solid #00d4ff; padding-bottom:0.5rem;">Week ${currentWeek}</h3>`;
      container.appendChild(weekContainer);
    }

    // Card
    const card = document.createElement('div');
    card.style = 'background:rgba(255,255,255,0.08); backdrop-filter:blur(20px); border-radius:16px; padding:1.5rem; margin-bottom:1rem; border:1px solid rgba(255,255,255,0.15);';
    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:1rem;">
        <div style="display:flex; align-items:center; flex-wrap:wrap; gap:1rem;">${teamsHtml}</div>
        <div style="text-align:right;">
          <span class="transaction-badge ${badgeClass}">${typeDisplay}</span>
          ${dateStr}
        </div>
      </div>
      <div style="margin-top:1.2rem; line-height:1.8; font-size:1.05rem;">${details.join('<br>')}</div>
    `;
    weekContainer.appendChild(card);
  });
}

function filterMatchups() {
  const week = document.getElementById('matchup-week').value;
  const team = document.getElementById('matchup-team').value;
  loadMatchups(week, team);
}

function filterTransactions() {
  loadTransactions(document.getElementById('trans-week').value);
}

function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
  document.getElementById(page).style.display = 'block';
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.querySelector(`nav button[onclick="showPage('${page}')"]`).classList.add('active');
}

function sortTable(tableId, col) {
  const table = document.getElementById(tableId);
  let switching = true;
  let dir = 'asc';
  while (switching) {
    switching = false;
    const rows = table.rows;
    for (let i = 1; i < rows.length - 1; i++) {
      let shouldSwitch = false;
      let x = rows[i].cells[col].textContent.trim();
      let y = rows[i + 1].cells[col].textContent.trim();
      if (!isNaN(x) && !isNaN(y)) {
        x = Number(x);
        y = Number(y);
      }
      if ((dir === 'asc' && x > y) || (dir === 'desc' && x < y)) {
        shouldSwitch = true;
        break;
      }
    }
    if (shouldSwitch) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
    } else if (dir === 'asc') {
      dir = 'desc';
      switching = true;
    }
  }
}

window.onload = loadData;
</script>
</body>
</html>
