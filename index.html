<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sleeper Fantasy League Dashboard</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f4f7fa;
    color: #333;
    margin: 0;
    padding: 0;
  }
  header {
    background: #1e3a8a;
    color: white;
    padding: 1rem 2rem;
    text-align: center;
  }
  h1 { margin: 0; font-size: 2rem; }
  section { padding: 1rem 2rem; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
  th, td { padding: 0.5rem; border: 1px solid #ddd; text-align: center; }
  th { background: #2563eb; color: white; position: sticky; top: 0; z-index: 2; }
  tr:nth-child(even) { background: #f9fafb; }
  tr:hover { background: #e0f2fe; }
  .collapsible {
    background-color: #2563eb;
    color: white;
    cursor: pointer;
    padding: 0.5rem 1rem;
    width: 100%;
    border: none;
    text-align: left;
    font-size: 1rem;
    margin-bottom: 0.5rem;
    border-radius: 5px;
  }
  .content {
    display: none;
    overflow: hidden;
    margin-bottom: 1rem;
  }
  .highlight { background: #fef3c7 !important; font-weight: bold; }
  .loading { text-align: center; padding: 1rem; font-size: 1.2rem; color: #2563eb; }
  @media (max-width: 768px) {
    th, td { font-size: 0.8rem; padding: 0.3rem; }
  }
</style>
</head>
<body>

<header>
  <h1>Sleeper Fantasy League Dashboard</h1>
</header>

<section>
  <button class="collapsible">ğŸ’° Money Leaderboard</button>
  <div class="content" id="moneyLeaderboard">
    <div class="loading">Loading...</div>
  </div>

  <button class="collapsible">ğŸ“Š League Standings</button>
  <div class="content" id="leagueStandings">
    <div class="loading">Loading...</div>
  </div>

  <button class="collapsible">ğŸ† Weekly High Scorers</button>
  <div class="content" id="weeklyWinners">
    <div class="loading">Loading...</div>
  </div>

  <button class="collapsible">ğŸ“ Recent Transactions</button>
  <div class="content" id="transactions">
    <div class="loading">Loading...</div>
  </div>
</section>

<script>
const csvLinks = {
  Config: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv',
  Owners: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv',
  Rosters: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv',
  WeeklyMatchups: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv',
  WeeklyBonuses: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv',
  Transactions: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR-PpZGo5sHtSw1wlCMdp3hKtL2Mfsop80Au0lr_AiOorIIGX-34lQfq2ZmHNBJq46z5kvaJRBq_hNc/pub?output=csv'
};

async function fetchCSV(url) {
  try {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const text = await resp.text();
    const rows = text.trim().split('\n').map(r => r.split(','));
    return rows;
  } catch(e) {
    console.error('Failed to load CSV', url, e);
    return [['Error loading CSV']];
  }
}

function createTable(containerId, headers, data, highlightFunc) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trHead = document.createElement('tr');
  headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; trHead.appendChild(th); });
  thead.appendChild(trHead);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  data.forEach(row => {
    const tr = document.createElement('tr');
    row.forEach(cell => {
      const td = document.createElement('td');
      td.textContent = cell;
      tr.appendChild(td);
    });
    if (highlightFunc && highlightFunc(row)) tr.classList.add('highlight');
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

function setupCollapsibles() {
  const coll = document.getElementsByClassName("collapsible");
  Array.from(coll).forEach(button => {
    button.addEventListener("click", function() {
      this.classList.toggle("active");
      const content = this.nextElementSibling;
      content.style.display = content.style.display === "block" ? "none" : "block";
    });
  });
}

async function renderDashboard() {
  const [ownersCsv, rostersCsv, matchupsCsv, bonusesCsv, transactionsCsv] = await Promise.all([
    fetchCSV(csvLinks.Owners),
    fetchCSV(csvLinks.Rosters),
    fetchCSV(csvLinks.WeeklyMatchups),
    fetchCSV(csvLinks.WeeklyBonuses),
    fetchCSV(csvLinks.Transactions)
  ]);

  // Map owner_id to display_name + team_name
  const ownersMap = {};
  ownersCsv.slice(1).forEach(r => { ownersMap[r[0]] = { name: r[1], team: r[2] }; });

  // MONEY LEADERBOARD
  const bonusesData = bonusesCsv.slice(1);
  const leaderboardMap = {};
  bonusesData.forEach(r => {
    const ownerId = r[1];
    const amount = parseFloat(r[5]) || 0;
    const type = r[3];
    if (!leaderboardMap[ownerId]) leaderboardMap[ownerId] = { total: 0, wins: 0 };
    leaderboardMap[ownerId].total += amount;
    if (type === 'HIGH_SCORE') leaderboardMap[ownerId].wins += 1;
  });
  const leaderboard = Object.keys(leaderboardMap).map(id => {
    const owner = ownersMap[id] || { name: 'Unknown', team: '' };
    return [owner.name, owner.team, leaderboardMap[id].total.toFixed(2), leaderboardMap[id].wins];
  }).sort((a,b)=>parseFloat(b[2])-parseFloat(a[2]));
  createTable('moneyLeaderboard', ['Owner', 'Team', 'Total Winnings', 'Weekly Wins'], leaderboard);

  // LEAGUE STANDINGS
  const standingsData = rostersCsv.slice(1).map(r => {
    const owner = ownersMap[r[1]] || { name: 'Unknown', team: '' };
    return [owner.name, owner.team, r[2], r[3], r[4], parseFloat(r[5]).toFixed(2), parseFloat(r[6]).toFixed(2)];
  }).sort((a,b)=>b[2]-a[2] || b[5]-a[5]);
  createTable('leagueStandings', ['Owner','Team','Wins','Losses','Ties','Points For','Points Against'], standingsData);

  // WEEKLY HIGH SCORERS
  const highScores = bonusesData.filter(r=>r[3]==='HIGH_SCORE').map(r => {
    const owner = ownersMap[r[1]] || { name:'Unknown', team:'' };
    return [r[0], owner.name, owner.team, parseFloat(r[4]).toFixed(2), parseFloat(r[5]).toFixed(2)];
  }).sort((a,b)=>a[0]-b[0]);
  createTable('weeklyWinners', ['Week','Owner','Team','Points','Bonus'], highScores);

  // RECENT TRANSACTIONS
  const transactionsData = transactionsCsv.slice(1).map(r=>[r[0], r[2], r[3], r[4], r[5]]);
  transactionsData.sort((a,b)=>new Date(b[4])-new Date(a[4]));
  createTable('transactions', ['Week','Type','Status','Roster Count','Timestamp'], transactionsData);
}

document.addEventListener('DOMContentLoaded', () => {
  setupCollapsibles();
  renderDashboard();
});
</script>

</body>
</html>
